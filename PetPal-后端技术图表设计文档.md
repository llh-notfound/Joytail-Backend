# PetPal后端技术图表详细设计文档

## 🎯 核心技术图表设计

### 1. 技术栈层次架构图

```
┌─────────────────────────────────────────────────────────┐
│                   前端应用层                             │
│            (React/Vue Mobile App & Web)                │
├─────────────────────────────────────────────────────────┤
│                   API网关层                             │
│         Express.js Router + CORS + Rate Limiting       │
├─────────────────────────────────────────────────────────┤
│                  中间件处理层                            │
│     Authentication + Validation + Logging + Error      │
├─────────────────────────────────────────────────────────┤
│                  业务逻辑层                             │
│    Controllers + Services + Business Rules Logic       │
├─────────────────────────────────────────────────────────┤
│                  数据访问层                             │
│         Redis Client + Connection Pool + Cache         │
├─────────────────────────────────────────────────────────┤
│                   基础设施层                            │
│              Node.js Runtime Environment               │
└─────────────────────────────────────────────────────────┘
```

**设计要点：**
- 每层使用不同颜色区分 (#2E86AB, #A23B72, #F18F01, #74AA9C)
- 层间使用箭头表示数据流向
- 每层标注主要技术组件

### 2. JWT认证流程详细图

```
用户登录流程：
┌─────────┐    POST /api/user/login    ┌─────────────┐
│  客户端  │ ────────────────────────→ │  Express.js │
│  应用   │                          │   服务器    │
└─────────┘                          └─────────────┘
     ↑                                       │
     │                                       ↓
     │                               ┌─────────────┐
     │                               │ 用户控制器   │
     │                               │ 验证凭据     │
     │                               └─────────────┘
     │                                       │
     │                                       ↓
     │                               ┌─────────────┐
     │                               │ JWT生成器   │
     │                               │ 签名Token   │
     │                               └─────────────┘
     │                                       │
     │ Token + User Info                     ↓
     └────────────────────────────── ┌─────────────┐
                                    │ Redis存储   │
                                    │ 用户会话    │
                                    └─────────────┘

后续请求验证：
┌─────────┐  Request + Authorization  ┌─────────────┐
│  客户端  │ ────────────────────────→ │ 认证中间件   │
│  应用   │                          │ JWT验证     │
└─────────┘                          └─────────────┘
     ↑                                       │
     │                                       ↓
     │                               ┌─────────────┐
     │                               │ Token解析   │
     │                               │ 用户信息提取 │
     │                               └─────────────┘
     │                                       │
     │                                       ↓
     │                               ┌─────────────┐
     │                               │ 权限检查     │
     │                               │ 角色验证     │
     │                               └─────────────┘
     │                                       │
     │ Response Data                         ↓
     └────────────────────────────── ┌─────────────┐
                                    │ 业务逻辑     │
                                    │ 处理请求     │
                                    └─────────────┘
```

### 3. Redis数据结构使用示例

```
用户数据 (Hash结构):
Key: user:12345
┌─────────────────────────────────┐
│ field: id        value: 12345   │
│ field: username  value: john123 │
│ field: email     value: j@ex.com│
│ field: role      value: user    │
│ field: createdAt value: 2024... │
└─────────────────────────────────┘

购物车数据 (List结构):
Key: cart:12345
┌─────────────────────────────────┐
│ [0] → {"productId": 1, "qty": 2}│
│ [1] → {"productId": 5, "qty": 1}│
│ [2] → {"productId": 8, "qty": 3}│
└─────────────────────────────────┘

社区点赞 (Set结构):
Key: post:67890:likes
┌─────────────────────────────────┐
│ member: user:12345              │
│ member: user:67890              │
│ member: user:11111              │
└─────────────────────────────────┘

热门排行 (Sorted Set结构):
Key: hot:products
┌─────────────────────────────────┐
│ score: 95.6  member: product:1  │
│ score: 87.3  member: product:15 │
│ score: 82.1  member: product:7  │
└─────────────────────────────────┘
```

### 4. 完整请求处理流程图

```
HTTP Request Processing Flow:

┌─────────────┐    1. HTTP请求      ┌─────────────┐
│   客户端     │ ────────────────→ │  Express.js │
│  (移动端/Web) │                   │   路由器    │
└─────────────┘                   └─────────────┘
                                          │
                                 2. 路由匹配
                                          ↓
                                  ┌─────────────┐
                          ┌──────│  CORS中间件  │
                          │      └─────────────┘
                          │              │
                   3. 中间件链             ↓
                          │      ┌─────────────┐
                          │  ───→│ 认证中间件   │
                          │      └─────────────┘
                          │              │
                          │              ↓
                          │      ┌─────────────┐
                          └─────→│ 验证中间件   │
                                 └─────────────┘
                                         │
                                4. 控制器处理
                                         ↓
                                ┌─────────────┐
                                │  控制器层    │ ←── 5. 业务逻辑调用
                                │ (Controller) │
                                └─────────────┘
                                         │
                                         ↓
                                ┌─────────────┐
                                │   服务层     │ ←── 6. 数据处理
                                │  (Service)  │
                                └─────────────┘
                                         │
                                         ↓
                                ┌─────────────┐
                                │ 数据访问层   │ ←── 7. Redis操作
                                │ (Data Layer)│
                                └─────────────┘
                                         │
                                         ↓
                                ┌─────────────┐
                                │    Redis    │ ←── 8. 数据存储
                                │   数据库     │
                                └─────────────┘
                                         │
                                   9. 返回数据
                                         ↓
┌─────────────┐   10. HTTP响应   ┌─────────────┐
│   客户端     │ ←─────────────── │ JSON响应     │
│ 接收响应数据  │                 │ 格式化输出   │
└─────────────┘                 └─────────────┘
```

### 5. 系统性能监控仪表板设计

```
┌─────────────────────────────────────────────────────────────────┐
│                       PetPal 后端性能监控                        │
├─────────────────────────────────────────────────────────────────┤
│  实时指标                                                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ 响应时间     │  │ 并发用户     │  │ 错误率       │              │
│  │    78ms     │  │    847      │  │   0.02%     │              │
│  │   (P95)     │  │  当前在线    │  │   过去1小时   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
├─────────────────────────────────────────────────────────────────┤
│  性能趋势图                                                      │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 响应时间 (ms)                                                │ │
│  │ 200┤                                                       │ │
│  │ 150┤     ●                                                 │ │
│  │ 100┤   ●   ●   ●                                           │ │
│  │  50┤ ●   ●   ●   ●   ●   ●                                 │ │
│  │   0└─────────────────────────────────────────────────────── │ │
│  │    00:00  04:00  08:00  12:00  16:00  20:00               │ │
│  └─────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  API调用统计                                                     │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 端点                请求数/小时    平均响应时间    成功率       │ │
│  │ /api/user/login       1,245         65ms       99.8%      │ │
│  │ /api/goods/list       2,156         45ms       99.9%      │ │
│  │ /api/community/posts  3,021         89ms       99.7%      │ │
│  │ /api/order/create       892        120ms       99.5%      │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 6. 系统架构拓扑图

```
                    PetPal 后端系统架构拓扑
                            
    ┌─────────────┐                    ┌─────────────┐
    │   客户端1    │                    │   客户端2    │
    │  (移动端)    │                    │   (Web端)   │
    └─────────────┘                    └─────────────┘
            │                                  │
            └──────────────┐          ┌────────┘
                          │          │
                          ↓          ↓
                    ┌─────────────────────┐
                    │     负载均衡器       │
                    │   (Nginx/HAProxy)   │
                    └─────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────────┐
        │              应用服务器集群                  │
        │  ┌─────────┐  ┌─────────┐  ┌─────────┐      │
        │  │Node.js 1│  │Node.js 2│  │Node.js 3│      │
        │  │Port:8080│  │Port:8081│  │Port:8082│      │
        │  └─────────┘  └─────────┘  └─────────┘      │
        └─────────────────────────────────────────────┘
                              │
                              ↓
                    ┌─────────────────────┐
                    │    Redis 集群        │
                    │  ┌─────┐  ┌─────┐    │
                    │  │主节点│  │从节点│    │
                    │  │6379 │  │6380 │    │
                    │  └─────┘  └─────┘    │
                    └─────────────────────┘
                              │
                              ↓
        ┌─────────────────────────────────────────────┐
        │              监控系统                       │
        │  ┌─────────┐  ┌─────────┐  ┌─────────┐      │
        │  │日志收集  │  │性能监控  │  │健康检查  │      │
        │  │(ELK)   │  │(Grafana)│  │(Custom) │      │
        │  └─────────┘  └─────────┘  └─────────┘      │
        └─────────────────────────────────────────────┘
```

### 7. 中间件处理链详细图

```
Express.js 中间件处理链：

请求进入 ─→ [CORS中间件] ─→ [解析Body] ─→ [认证中间件] ─→ [验证中间件] ─→ [控制器] ─→ 响应

详细处理流程：

1. CORS中间件
   ├─ 检查Origin头
   ├─ 设置Access-Control-Allow-*头
   └─ 处理OPTIONS预检请求

2. Body解析中间件
   ├─ JSON解析 (express.json())
   ├─ URL编码解析 (express.urlencoded())
   └─ 文件上传处理 (multer)

3. 认证中间件 (auth.js)
   ├─ 提取Authorization头
   ├─ JWT Token验证
   ├─ Token解码获取用户信息
   └─ 设置req.user对象

4. 验证中间件 (express-validator)
   ├─ 参数格式验证
   ├─ 必填字段检查
   ├─ 数据类型验证
   └─ 自定义业务规则验证

5. 控制器处理
   ├─ 业务逻辑执行
   ├─ 数据库操作
   ├─ 响应数据组装
   └─ 错误处理

错误处理：
任何环节出错 ─→ [全局错误处理中间件] ─→ 统一错误响应格式
```

## 🎨 视觉设计规范

### 颜色规范：
- **主色调：** #2E86AB (深蓝色) - 技术可靠性
- **辅助色1：** #A23B72 (紫红色) - 业务逻辑层
- **辅助色2：** #F18F01 (橙色) - 数据层
- **强调色：** #74AA9C (青绿色) - 性能指标
- **文字色：** #333333 (深灰色)
- **背景色：** #FFFFFF (白色)

### 图标设计：
- **技术图标：** 使用官方logo (Node.js绿色, Redis红色)
- **流程图标：** Material Design风格
- **状态图标：** 圆形指示器 (绿色=正常, 黄色=警告, 红色=错误)

### 图表样式：
- **线图：** 2px粗细，圆角端点
- **柱状图：** 圆角矩形，渐变填充
- **饼图：** 3D效果，清晰标签
- **流程图：** 圆角矩形节点，箭头连接

这些图表设计为制作专业的后端技术PPT提供了完整的视觉支持。
